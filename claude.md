# Metro-Inflow-Optimization Project Context

## Overview
This project optimizes passenger inflow into metro systems to prevent overcrowding. It supports multiple regions (Doha, Shanghai) through a TOML-based configuration system.

## Multi-Region Configuration

### Config Files
- `config/doha.toml` - Doha Metro (15-minute intervals, dates: 2022-11-27 to 2022-11-30)
- `config/shanghai.toml` - Shanghai Metro (10-minute intervals, dates: 2017-05-01 to 2017-08-31)

### Key Config Fields
```toml
[region]
name = "doha"                    # Used in output filenames
display_name = "Doha Metro"

[paths]
base_dir = "data_public/Doha"    # Data directory
metroarcs_file = "metroarcs_doha.csv"
stations_file = "stations_doha.csv"
od_file_pattern = "OD_{date}.csv"

[time]
interval_minutes = 15            # Base time interval (15 for Doha, 10 for Shanghai)
closed_hours = [3, 4, 5]         # Metro closure hours
date_format = "yyyy-mm-dd"
```

## Running the Framework

### Parallel Framework (recommended)
```bash
# Doha (default)
julia metro_framework_parallel.jl 15 '2022-11-29T05:00:00' '2022-11-30T04:59:00'

# Shanghai
julia metro_framework_parallel.jl --config config/shanghai.toml 10 '2017-05-08T05:00:00' '2017-05-09T04:59:00'
```

### Simple Framework (quick testing)
Edit `CONFIG_FILE` and dates in `metro_framework.jl`, then:
```bash
julia metro_framework.jl
```

### Shell Script
Edit `CONFIG` variable in `run_parallel_metro.sh`, then:
```bash
./run_parallel_metro.sh
```

## Shanghai Data Preprocessing

### 1. Build Metro Arcs (network structure + capacities)

The metro arcs file defines the network topology, travel times, and capacities:

```bash
cd data_public/Shanghai
julia --project=../../metroflow build_metroarcs.jl
```

**Methodology** (from paper):
- Travel time: 80 km/h train speed + 30s dwell, rounded to 1-minute steps (min 1 min)
- Capacity: Peak observed hourly OD flow / 60 (passengers per minute)
- Consistency: All arcs on same line have identical capacity (line maximum)

**Runtime**: ~20-30 minutes (processes 11GB OD file for capacity estimation)

### 2. Transform OD Data (daily flow files)

The Shanghai OD data (`metroData_ODFlow.csv`, 11GB) must be transformed to daily files:

```bash
cd data_public/Shanghai
julia --project=../../metroflow transform_od.jl 2017-05-10 2017-05-14   # Wed-Sun
julia --project=../../metroflow transform_od.jl 2017-05-10 2017-05-16   # Full week (Wed-Tue)
```

**Note**: May 8-9, 2017 have incomplete OD data (<2% of usual ridership). Use May 10+ for complete data.

### 3. Verify Transformation

Compare generated OD files against InOutFlow data:
```bash
julia --project=../../metroflow verify_od.jl 2017-05-10 2017-05-14
```

Expected: ~2% difference is normal (OD only contains complete trips, InOutFlow counts all taps).

## Data Directory Structure
```
data_public/
├── Doha/
│   ├── OD_2022-11-27.csv ... OD_2022-11-30.csv
│   ├── metroarcs_doha.csv
│   └── stations_doha.csv
└── Shanghai/
    ├── metroData_ODFlow.csv (raw OD data, 11GB)
    ├── metroData_InOutFlow.csv (station in/out flows, 217MB)
    ├── stationInfo.csv
    ├── metroarcs_shanghai.csv (generated by build_metroarcs.jl)
    ├── build_metroarcs.jl (builds network arcs with empirical capacity)
    ├── transform_od.jl (transforms OD to daily files)
    ├── verify_od.jl (verifies transformation)
    └── OD_*.csv (generated daily files)
```

## Output Files

Results are saved with region prefix to prevent overwrites:
- `results/logfile_{region}_{start_time}_{minutes}.csv` - Aggregated summary
- `results/queues/sim_queues_{region}_*.csv` - Queue simulation data
- `results/arcs/sim_arcs_{region}_*.csv` - Arc utilization data
- `results/log_{region}_mip_*.txt` - Run journal

## Key Source Files

| File | Purpose |
|------|---------|
| `functions/config.jl` | Configuration loading (RegionConfig struct) |
| `functions/metro_functions.jl` | Data loading (load_demand, aggregate_demand) |
| `functions/metro_simulation.jl` | Simulation (uses config.interval_minutes) |
| `functions/metro_heuristic.jl` | Optimization heuristic |
| `functions/metro_model.jl` | JuMP optimization models |
| `metro_data_summary.jl` | Analysis and visualization |

## Important Notes

1. **minutes_in_period must be a multiple of config.interval_minutes**
   - Doha: 15, 30, 45, 60
   - Shanghai: 10, 20, 30, 40, 50, 60

2. **Old data directories removed**: `data_demand/` and `data_metro/` no longer exist. All data is in `data_public/{region}/`.

3. **Renaming old result files**: See `results/README_file_renaming.md` for scripts to add region prefix to legacy files.

4. **Station naming**: Both regions use `Metro_StationName` format (e.g., `Metro_Msheireb`, `Metro_LongcaoRoad`).
